<head>
  <meta charset='utf-8'/>
  <meta name="viewport" content="user-scalable=no">
  <meta name='theme-color' content='#172244'>
  <link href='https://fonts.googleapis.com/css2?family=Dancing+Script&display=swap' rel='stylesheet'> 
  <style>
    html {
      background-color: #071722;
      height: 100vh;
    }
    body {
      margin: 0;
      position: relative;
      width: 100vw;
      height: 100%;
      height: calc(var(--vh, 1%) * 100);
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: flex-start;
    }
    canvas {
      width: 100%;
      height: 100%;
      position: absolute;
      top: 0;
      left: 0;
    }
    div#backdrop {
      width: 100%;
      height: 100%;
      background: #172244;
      position: absolute;
      top: 0;
      left: 0;
    }
    img#merry-christmas {
      position: relative;
      max-height: 95%;
      max-width: 95%;
      width: auto;
      height: auto;
      backface-visibility: hidden;
      -webkit-backface-visibility: hidden;
      animation-duration: 2s;
      opacity: 0;
      transform: translateX(5%);
      pointer-events: none;
      filter: drop-shadow(0 0 32px #172244);
    }
    img#merry-christmas.animate {
      animation-name: merry-christmas;
      opacity: 1;
    }
    div#prompt {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      pointer-events: none;
      user-select: none;
      animation-name: prompt;
      animation-duration: 1.5s;
      animation-delay: 4s;
      animation-fill-mode: both;
      
      font-size: 40px;
      font-family: 'Dancing Script', serif;
      padding: 0.3em;
      background-color: #172244;
      color: #F0C432;
      border: 2px ridge #DDEEFF;
      white-space: nowrap;
    }
    @keyframes merry-christmas {
      from {
        transform: scale(0.5) translateY(-50%);
        opacity: 0;
      }
      25% {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }
    @keyframes prompt {
      from {
        bottom: 0;
        opacity: 0;
      }
      to {
        bottom: 0.75em;
        opacity: 1;
      }
    }
    @media screen and (max-width: 1664px) {
      body {
        justify-content: center;
        align-items: flex-start;
      }
      img#merry-christmas {
        transform: translateY(2.5%);
      }
    }
    @media screen and (min-resolution: 1.5dppx) {
      div#prompt {
        font-size: 10vw;
      }
      canvas#tree {
        transform: scale(1.25);
        transform-origin: bottom center;
      }
    }
    div#debug {
      position: fixed;
      top: 0;
      width: 100vw;
      height: fit-content;
      background-color: #071722;
      color: #DDEEFF;
      font-size: 24px;
      font-family: 'Courier New', Courier, monospace;
    }
  </style>
  <script src='perlin.js'></script>
  <script src='load_image.js'></script>
  <script src='snowflakes.js'></script>
  <script src='light_data.js'></script>
  <script src='tree.js'></script>
</head>
<body>
  <div id='backdrop'></div>
  <img id='merry-christmas' src='merry_christmas.webp' width=768 height=636>
  <div id='prompt'>click the screen</div>
  <!-- <audio id='music' loop><source src='christmas-song.wav' type='audio/wav'></audio> -->
  <div id='debug'></div>
  <script>
    function click_handler() {
      document.querySelector('#prompt').remove();
      document.querySelector('#merry-christmas').classList.add('animate');
      // document.querySelector('#music').play();
      window.removeEventListener('click', click_handler);
    }
    window.addEventListener('click', click_handler);
  </script>
  <script>
    const dt = 17;
    const body = document.querySelector('body');
    const debug = document.querySelector('#debug');

    let previous = performance.now();
    let accumulator = 0; // frame-by-frame spare time accumulator
    let elapsed = 0; // total elapsed time in animation
    // this runs every frame
    function animate(timestamp) {
      // track the frame length
      const frame_time = timestamp - previous;
      previous = timestamp;
      // add it to the accumulator
      accumulator += frame_time;
      // if there's more than 8 frames to process, just drop them
      if (accumulator > dt * 8) {
        accumulator = 0;
      }
      // run down the accumulator in dt sized chunks
      while (accumulator >= 0) {
        // run updates on each animation
        animations.forEach(a => a.integrate(elapsed));
        accumulator -= dt;
        elapsed += dt;
      }
      // render each animation
      animations.forEach(a => a.render());
      window.requestAnimationFrame(animate);
    }

    animations.forEach(a => {
      // give each animation a canvas
      let canvas = document.createElement('canvas');
      canvas.id = a.name;
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
      const after = document.querySelector(a.after);
      if (after) {
        after.after(canvas);
      } else {
        document.querySelector('body').appendChild(canvas);
      }
      a.init(canvas);
    });

    const resize_handler = () => {
      animations.forEach(a => {
        document.documentElement.style.setProperty('--vh', `${window.innerHeight * 0.01}px`);
        const new_width = window.innerWidth;
        const new_height = window.innerHeight;
        body.style.height = new_height;
        // run the animation's state update for this
        a.on_resize(new_width, new_height);
        // resize its canvas
        a.canvas().width = new_width;
        a.canvas().height = new_height;
//         debug.innerHTML = `vh: ${document.documentElement.style.getPropertyValue('--vh')}<br/>
// body: [w: ${body.clientWidth}, h:${body.clientHeight}]<br/>
// window: [w: ${window.innerWidth}, h:${window.innerHeight}]<br/>
// canvases: [w: ${a.canvas().clientWidth}, h:${a.canvas().clientHeight}]`;
        });
    };

    document.documentElement.style.setProperty('--vh', `${window.innerHeight * 0.01}px`);
    window.addEventListener('resize', resize_handler);
    window.addEventListener('scroll', resize_handler);
    window.addEventListener('click', resize_handler);
    window.addEventListener('orientationchange', resize_handler);

    window.requestAnimationFrame(animate);
  </script>
</body>