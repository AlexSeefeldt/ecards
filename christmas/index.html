<head>
  <title>Merry Christmas!</title>
  <meta charset='utf-8'/>
  <meta name='theme-color' content='#172244'>
  <meta name='viewport' content='user-scalable=no'>
  <link rel='icon' type='image/x-icon' href='./favicon.ico'>
  <link rel='preconnect' href='https://fonts.googleapis.com'>
  <link rel='preconnect' href='https://fonts.gstatic.com' crossorigin>
  <link href='https://fonts.googleapis.com/css2?family=Texturina:wght@200&display=swap' rel='stylesheet'> 
  <style>
    html {
      background-color: #071722;
      height: 100vh;
    }
    body {
      margin: 0;
      position: relative;
      width: 100vw;
      height: 100%;
      height: calc(var(--vh, 1%) * 100);
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    canvas {
      width: 100%;
      height: 100%;
      position: absolute;
      top: 0;
      left: 0;
    }
    div#backdrop {
      width: 100%;
      height: 100%;
      background-color: #172244;
      position: absolute;
      top: 0;
      left: 0;
    }
    img#merry-christmas {
      position: relative;
      max-height: calc(100% - 184px);
      max-width: 95%;
      width: auto;
      height: auto;
      backface-visibility: hidden;
      -webkit-backface-visibility: hidden;
      animation-duration: 2s;
      opacity: 0;
      transform: translateX(5%);
      pointer-events: none;
      filter: drop-shadow(0 0 32px #172244);
    }
    img#merry-christmas.animate {
      animation-name: merry-christmas;
      opacity: 1;
    }
    nav {
      position: relative;
      z-index: 1;
      user-select: none;
      white-space: nowrap;
      display: flex;
      flex-direction: column;
      align-items: center;
      background-image: linear-gradient(to right, #071722, #172244 50%, #172244AA);
      color: #DDEEFF;
      font-size: 2em;
      width: 6.2em;
      font-family: Texturina;
      padding: 0.25em 2.5em 0.25em 0.5em;
      transform: translateX(2em);
      border-radius: 0.125em;
      border: 0.0625em groove #F0C432;
      opacity: 1;
      transition: transform 800ms, opacity 600ms;
    }
    nav.slow {
      transition: transform 3000ms, opacity 2250ms;
    }
    nav.hide {
      transform: translateX(110%);
      opacity: 0;
    }
    nav .icon {
      margin-right: 5px;
      width: 1em;
      height: 1em;
    }
    .icon.hide {
      display: none;
    }
    nav label {
      transform: translateY(-0.125em);
      cursor: pointer;
    }
    nav .option {
      width: 100%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-radius: 0.125em;
      filter: drop-shadow(0 0 0.03125em #DDEEFF);
    }
    button, a {
      display: inline-block;
      border: initial;
      background: initial;
      font: inherit;
      color: inherit;
      text-decoration: initial;
      -webkit-appearance: none;
      -moz-appearance: none;
      padding: 0;
      margin: 0;
      -webkit-tap-highlight-color: transparent;
    }
    button:focus, a:focus {
      outline: none;
      color: #99CCFF;
      filter: drop-shadow(0 0 0.03125em #99CCFF);
    }
    @keyframes merry-christmas {
      from {
        transform: scale(0.5) translateY(-50%);
        opacity: 0;
      }
      25% {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }
    @media screen and (max-width: 1664px) {
      body {
        flex-direction: column;
      }
      img#merry-christmas {
        transform: translateY(2.5%);
      }
      nav {
        padding: 0.25em 0.5em 2.25em 0.5em;
        transform: translateY(2em);
        background-image: linear-gradient(to bottom, #071722DD, #172244B7 50%, #172244AA);
      }
      nav.hide {
        transform: translateY(100%);
      }
    }
    @media screen and (min-resolution: 1.5dppx) {
      nav {
        font-size: 10vw;
      }
      canvas#tree {
        transform: scale(1.25);
        transform-origin: bottom center;
      }
    }
  </style>
  <script type='module' src='js/snow.js'></script>
  <script type='module' src='js/tree.js'></script>
</head>
<body>
  <div id='backdrop'></div>
  <img id='merry-christmas' src='merry_christmas.webp' width=768 height=636>
  <nav class='hide'>
    <button class='option' id='play-option'>
      <svg xmlns='http://www.w3.org/2000/svg' width='32' height='32' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' class='icon play'><polygon points='5 3 19 12 5 21 5 3'></polygon></svg>
      <svg xmlns='http://www.w3.org/2000/svg' width='32' height='32' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' class='icon hide pause'><rect x='6' y='4' width='4' height='16'></rect><rect x='14' y='4' width='4' height='16'></rect></svg>
      <label>Play song</label>
    </button>
    <a class='option' id='read-option' href='./letter.html'>
      <svg xmlns='http://www.w3.org/2000/svg' width='32' height='32' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' class='icon read'><path d='M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z'></path><polyline points='14 2 14 8 20 8'></polyline><line x1='16' y1='13' x2='8' y2='13'></line><line x1='16' y1='17' x2='8' y2='17'></line><polyline points='10 9 9 9 8 9'></polyline></svg>
      <label>Read letter</label>
    </a>
  </nav>
  <audio id='music' loop><source src='audio/seerp-009.wav' type='audio/wav'></audio>
  <script type='module'>
    // UI code
    // selectors for the various HTML elements used
    const music = document.querySelector('#music');
    const play_option = document.querySelector('#play-option');
    const play = play_option.querySelector('.play');
    const pause = play_option.querySelector('.pause');
    const play_option_label = play_option.querySelector('label');
    
    const nav = document.querySelector('nav');
    const merry_christmas = document.querySelector('#merry-christmas');

    const HIDE_NAV_TIMEOUT = 4096;
    
    // mutable states
    let playing = false;
    let mouseover_blocked = false;
    let hiding_blocked = false;
    let timeout_id;

    // when the play/pause option is clicked
    play_option.addEventListener('click', () => {
      // stop hiding the nav if it's hiding
      nav.classList.remove('hide', 'slow');

      playing = !playing;
      if (playing) {
        music.play();
      } else {
        music.pause();
      }

      // restart the timeout to hide the nav
      if (timeout_id) {
        window.clearTimeout(timeout_id);
      }
      timeout_id = window.setTimeout(hide_nav, HIDE_NAV_TIMEOUT);
    });

    // if music is played (either from the nav button or from an external action)
    music.addEventListener('play', () => {
      playing = true;
      // show the correct icon and update text
      pause.classList.remove('hide');
      play.classList.add('hide');
      play_option_label.innerText = 'Pause song';
    });

    // if music is paused (either from the nav button or from an external action)
    music.addEventListener('pause', () => {
      playing = false;
      // show the correct icon and update text
      play.classList.remove('hide');
      pause.classList.add('hide');
      play_option_label.innerText = 'Play song';
    });

    // used in timeout
    function hide_nav() {
      nav.classList.add('hide', 'slow');
    }

    // mouse is in last 10th of screen, according to active layout (cf. the css)
    function is_in_hot_zone({ x, y }) {
      return document.body.clientWidth > 1664
        ? x > document.body.clientWidth * 0.9
        : y > document.body.clientHeight * 0.9;
    }

    // on a window click, toggle the visibility of the nav
    window.addEventListener('click', e => {
      // if it's a click on the nav, or the nav has not appeared for the first time (triggered automatically after page load) and been clicked
      if (nav.contains(e.target) || !timeout_id) {
        return;
      }

      // reset the nav hiding timeout
      window.clearTimeout(timeout_id);
      if (nav.classList.contains('hide')) {
        // if the nav is hidden, unhide it and restart the timeout
        nav.classList.remove('hide', 'slow');
        timeout_id = window.setTimeout(hide_nav, HIDE_NAV_TIMEOUT);
      } else if (!hiding_blocked) {
        // otherwise, hide it, and block mouseover activation of the nav (until it exits the hot zone, cf. mousemove handler)
        nav.classList.add('hide');
        if (is_in_hot_zone(e)) {
          mouseover_blocked = true;
        }
      }
    });

    // mouse entering the last 10th of the screen activates the nav
    window.addEventListener('mousemove', e => {
      if (is_in_hot_zone(e)) {
        // cannot be activated if mouseover is blocked or the nav has not appeared for the first time and been clicked
        if (!mouseover_blocked && timeout_id) {
          // timeout to hide has to be reset too
          window.clearTimeout(timeout_id);
          nav.classList.remove('hide', 'slow');
          timeout_id = window.setTimeout(hide_nav, HIDE_NAV_TIMEOUT);
          // block nav dismissal until it's fully entered
          hiding_blocked = true;
          window.setTimeout(() => hiding_blocked = false, 800);
        }
      } else {
        // if mouse is no longer in the hot zone, unblock mouseover activation
        mouseover_blocked = false;
      }
    });

    // pop up "merry christmas" and the nav
    window.setTimeout(() => merry_christmas.classList.add('animate'), 1536);
    window.setTimeout(() => nav.classList.remove('hide'), 3072);
  </script>
  <script type='module'>
    // animation code
    import { snow } from './js/snow.js';
    import { tree } from './js/tree.js';

    const animations = [snow, tree];

    const dt = 17;
    const body = document.querySelector('body');
    // const debug = document.querySelector('#debug');

    let previous = performance.now();
    let accumulator = 0; // frame-by-frame spare time accumulator
    let elapsed = 0; // total elapsed time in animation
    // this runs every frame
    function animate(timestamp) {
      // track the frame length
      const frame_time = timestamp - previous;
      previous = timestamp;
      // add it to the accumulator
      accumulator += frame_time;
      // if there's more than 8 frames to process, just drop them
      if (accumulator > dt * 8) {
        accumulator = 0;
      }
      // run down the accumulator in dt sized chunks
      while (accumulator >= 0) {
        // run updates on each animation
        animations.forEach(a => a.integrate(elapsed));
        accumulator -= dt;
        elapsed += dt;
      }
      // render each animation
      animations.forEach(a => a.render());
      window.requestAnimationFrame(animate);
    }

    animations.forEach(a => {
      // give each animation a canvas
      let canvas = document.createElement('canvas');
      canvas.id = a.name;
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
      // place each animation canvas after the element it asks to be placed after
      const after = document.querySelector(a.after);
      if (after) {
        after.after(canvas);
      } else {
        document.querySelector('body').appendChild(canvas);
      }
      // run init routine for animation with new canvas
      a.init(canvas);
    });

    const resize_handler = () => {
      // update the viewport height percent unit (thanks CSS Tricks)
      document.documentElement.style.setProperty('--vh', `${window.innerHeight * 0.01}px`);
      // get new size from window
      const new_width = window.innerWidth;
      const new_height = window.innerHeight;
      // update body style to match window
      body.style.height = new_height;
      animations.forEach(a => {
        // run the animation's state update for this
        a.on_resize(new_width, new_height);
        // resize its canvas
        a.canvas().width = new_width;
        a.canvas().height = new_height;
      });
    };

    document.documentElement.style.setProperty('--vh', `${window.innerHeight * 0.01}px`);
    window.addEventListener('resize', resize_handler);
    window.addEventListener('scroll', resize_handler);
    window.addEventListener('orientationchange', resize_handler);

    window.requestAnimationFrame(animate);
  </script>
</body>